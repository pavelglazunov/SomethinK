{% extends "base.html" %}

{% block css_connect %}
<link href="/static/css/create/toast.css" rel="stylesheet">
<link href="/static/css/main/index.css" rel="stylesheet">
<script src="/static/js/toast.js"></script>
<script src="/static/js/toasts.js"></script>
{% endblock %}

{% block content %}
<!--<section class="section" style="margin-top: 5vw">-->
<!--    <div class="section_content">-->
<!--        <h1 class="section_text">{{ data.username }}</h1>-->
<!--        <div class="user_data">-->
<!--            <div class="user_data_row">-->
<!--                <div class="red_button logout_button">выйти из аккаунта</div>-->
<!--                <div class="red_button remove_account_button">удалить аккаунт</div>-->
<!--&lt;!&ndash;                {% if data.auth_with_discord %}&ndash;&gt;-->
<!--&lt;!&ndash;                    <div class="connect_discord_button">Дискорд привязан</div>&ndash;&gt;-->
<!--&lt;!&ndash;                {% else %}&ndash;&gt;-->
<!--&lt;!&ndash;                    <a href="{{ data.redirect_oauth_url }}" class="connect_discord_button not_connect">привязать дискорд</a>&ndash;&gt;-->
<!--&lt;!&ndash;                {% endif %}&ndash;&gt;-->
<!--&lt;!&ndash;                <img class="discord_accept_icon" src="/static/img/icons8-accept.svg">&ndash;&gt;-->
<!--&lt;!&ndash;                <p>Discord привязан</p>&ndash;&gt;-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->


<!--</section>-->

<div class="user_page_content">
    <section class="section" style="margin-top: 5vw">
        <div class="section_header">
            <div class="line" style="width: 17vw"></div>
            <div class="section_name">ваши боты</div>

        </div>

        <div class="overlay hidden"></div>

        <div class="bots_block">
            <div class="modal hidden">
                <!--            <div class="">-->
                <div class="modal_text_block">
                    <h3 class="modal_header">удалить бота?</h3>
                    <p class="remove_bot_text" id="modal_text"></p>
                </div>

                <button id="I_really_want_to_remove_this_cool_bot_button" class="I_really_want_to_remove_this_cool_bot">
                    удалить бота
                </button>
            </div>

            {% for el in data.user_project %}
            <div class="project" id="project_{{ el.id }}">
                <p class="bot_name">{{ el.name }}</p>
                <div class="bots_buttons">
                    <div class="project_buttons bot_edit_button" id="bot_edit_button_{{ el.id }}">редактировать</div>
                    <div class="project_buttons bot_download_button" id="bot_download_button_{{ el.id }}"
                         project_name="{{ el.name }}">скачать
                    </div>
                    <div class="red_button bot_remove_button" project_name="{{ el.name }}"
                         style="height: 2vw; width: max-content;"
                         id="bot_remove_button_{{ el.id }}">удалить
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>


        <!--    <p>Projects: {{ data.user_project }}</p>-->

    </section>
    <div class="logout_footer">
        <div class="buttons_block">
            <a href="/create/token" class="green_button logout_button">создать бота</a>
            <a href="/auth/logout" class="red_button logout_button">выйти из аккаунта</a>
            <div class="red_button remove_account_button" id="remove_account :(">удалить аккаунт</div>
        </div>
        <div class="forms_block hidden" id="form_block">
            <p class="texts" style="font-size: 1vw">Для удаления аккаунта введите пароль</p>
            <input class="red_input" type="password" placeholder="Пароль" id="password_input">
        </div>

        <div class="forms_block hidden" id="remove_account_button_form">
            <div class="remove_account red_button" id="really_remove_account_button">
                удалить
            </div>
        </div>

    </div>
</div>


<script>
    const modal_header_text = document.getElementById("modal_text")

    const modal = document.querySelector(".modal");
    const overlay = document.querySelector(".overlay");

    const project_remove_buttons = document.getElementsByClassName("bot_remove_button")

    const project_edit_buttons = document.getElementsByClassName("bot_edit_button")
    for (let i of project_edit_buttons) {
        i.addEventListener("click", function () {
            let button_id = i.id

            const response = fetch("../api/edit", {
                method: "POST",
                mode: "cors",
                cache: "no-cache",
                credentials: "same-origin",
                headers: {
                    "Content-Type": "application/json",
                    "project_id": button_id
                },
                redirect: "follow",
                referrerPolicy: "no-referrer",
                // body: JSON.stringify(data)


            })
            if (response.status === 429) {
                danger("Слишком много запросов в минуту")
                return 0
            }

            window.location.href = "http://127.0.0.1:8080/create/moderation"


        })
    }
    let selected_bot_id
    for (let i of project_remove_buttons) {
        i.addEventListener("click", function () {
            console.log(122)
            selected_bot_id = i.id

            console.log(i.id)
            console.log(selected_bot_id)

            let name = i.getAttribute("project_name")
            modal_header_text.textContent = "Вы уверены, что хотите безвозвратно удалить бота " + name + "?"

            modal.classList.remove("hidden");
            overlay.classList.remove("hidden");
        })
    }
    const closeModal = function () {
        modal.classList.add("hidden");
        overlay.classList.add("hidden");
    };
    document.getElementById("I_really_want_to_remove_this_cool_bot_button").addEventListener("click", function () {
        console.log(selected_bot_id)
        const response = fetch("../api/remove", {
            method: "POST",
            mode: "cors",
            cache: "no-cache",
            credentials: "same-origin",
            headers: {
                "Content-Type": "application/json",
                "project_id": selected_bot_id
            },
            redirect: "follow",
            referrerPolicy: "no-referrer",
            // body: JSON.stringify(data)


        })

        closeModal()

        // console.log(response.json())
        const removed = document.getElementById("project_" + selected_bot_id.split("_")[3])
        console.log(selected_bot_id)
        console.log(selected_bot_id.split("_"))
        console.log(selected_bot_id.split("_")[-1])
        console.log(selected_bot_id.split("_")[3])
        removed.remove()
        // if (response["status"] === "ok") {
        //     successText(response["message"])
        // }
        // window.location.reload()

        // window.location.href = "http://127.0.0.1:8080/create/moderation"
    })

    // const closeModalBtn = document.querySelector(".btn-close");

    // closeModalBtn.addEventListener("click", closeModal);
    overlay.addEventListener("click", closeModal);

</script>
<script>
    const project_download_buttons = document.getElementsByClassName("bot_download_button")
    for (let i of project_download_buttons) {
        i.addEventListener("click", async function () {
            let button_id = i.id
            let project_name = i.getAttribute("project_name")

            const response = await fetch("../api/download", {
                method: "POST",
                mode: "cors",
                cache: "no-cache",
                credentials: "same-origin",
                headers: {
                    "Content-Type": "application/json",
                    "project_id": button_id
                },
                redirect: "follow",
                referrerPolicy: "no-referrer",
                // body: JSON.stringify(data)


            })
            if (response.status === 429) {
                danger("Слишком много запросов в минуту")
                return 0
            }
            const blob = await response.blob();

            if (blob.type === "application/json") {
                // Если ответ в виде JSON
                const json = await blob.text();
                const data = JSON.parse(json);

                if (data.status !== "ok") {
                    // Если статус не 'ok' - показываем ошибку
                    danger(data.message);
                    return 0;
                }
            } else {
                // Если ответ не в виде JSON - скачиваем файл
                const url = URL.createObjectURL(blob);

                // Создаем ссылку для скачивания файла
                const link = document.createElement("a");
                link.href = url;
                link.download = project_name + ".zip"; // Указываем имя файла
                document.body.appendChild(link);

                // Кликаем по ссылке для скачивания файла
                link.click();

                // Удаляем ссылку
                document.body.removeChild(link);

                // Освобождаем ресурсы
                URL.revokeObjectURL(url);
            }
            // window.location.href = "http://127.0.0.1:8080/create/moderation"


        })
    }
</script>
<script>
    const remove_button = document.getElementById("remove_account :(")

    remove_button.addEventListener("click", function () {
        let form = document.getElementById("form_block")
        if (form.classList.contains("hidden")) {
            form.classList.remove("hidden")
            remove_button.textContent = "отмена"
        }
        else {
            form.classList.add("hidden")
            remove_account_button.classList.add("hidden")
            remove_button.textContent = "удалить аккаунт"

        }
    })
    const remove_account_button = document.getElementById("remove_account_button_form")
    const password_input = document.getElementById("password_input")
    password_input.addEventListener("input", function () {

        if (password_input.value !== "") {

            console.log(remove_account_button.classList)
            if (remove_account_button.classList.contains("hidden")) {
                remove_account_button.classList.remove("hidden")

            }
        }
        else {
            remove_account_button.classList.add("hidden")
        }
    })


    const really_remove_account_button = document.getElementById("really_remove_account_button")
    really_remove_account_button.addEventListener("click", async function () {
        const response = await fetch("../api/remove_account", {
            method: "POST",
            mode: "cors",
            cache: "no-cache",
            credentials: "same-origin",
            headers: {
                "Content-Type": "application/json",
                "password": password_input.value
            },
            redirect: "follow",
            referrerPolicy: "no-referrer",
            // body: JSON.stringify(data)


        })
        if (response.status === 429) {
            danger("Слишком много запросов в минуту")
            return 0
        }

        const answer = await response.json()

        if (answer["status"] !== "ok") {
            danger(answer["message"])
            return 0
        }

        window.location.href = "http://127.0.0.1:8080/"


    })

</script>

<!--профиль номер: {{data}}-->
<!--<a href="/auth/logout">выйти</a>-->
{% endblock %}